<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - UniSync</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="lib/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2F345C',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: #1f2441 !important;
            color: #f5f5f5 !important;
        }

        body.dark-mode .bg-primary {
            background-color: #1a1f35 !important;
        }

        body.dark-mode .bg-white {
            background-color: #2F345C !important;
        }

        body.dark-mode .text-gray-600 {
            color: #aaa !important;
        }

        body.dark-mode .border-gray-200 {
            border-color: #444 !important;
        }

        .theme-toggle-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4b5cb7;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            background: #3a46a1;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4b5cb7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-primary min-h-screen" x-data="roomFinder()">
    <div class="bg-primary text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">Room Finder</h1>
                <p class="text-sm text-gray-300 mt-1" x-text="currentTime"></p>
            </div>
            <a href="home.html" class="bg-white/10 hover:bg-white/20 border border-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                ‚Üê Back to Home
            </a>
        </div>
    </div>

    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">üåô</button>

    <div class="max-w-7xl mx-auto px-6 py-10">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-primary mb-2">Room Finder</h2>
            <p class="text-gray-600">Select a campus block to view available rooms</p>
        </div>

        <!-- Added loading state -->
        <div x-show="loading" class="text-center py-20">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 mt-4">Loading room schedules...</p>
        </div>

        <!-- Added error state -->
        <div x-show="error" x-transition class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
            <p x-text="error"></p>
        </div>

        <div x-show="selectedBlock && !loading" x-transition class="bg-white rounded-xl shadow-md p-8 mb-8 fade-in">
            <h3 class="text-2xl font-semibold text-primary mb-6" x-text="`Block ${selectedBlock} - All Rooms`"></h3>
            
            <template x-for="floor in [1, 2, 3]" :key="floor">
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-primary mb-4" x-text="getFloorName(floor)"></h4>
                    <div class="grid grid-cols-5 gap-3">
                        <template x-for="room in 4" :key="room">
                            <div @click="showRoomDetails(`${selectedBlock}${floor}0${room}`)"
                                 :class="getRoomAvailability(`${selectedBlock}${floor}0${room}`) ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800'" 
                                 class="border-2 rounded-lg p-3 text-center font-medium cursor-pointer hover:shadow-lg transition-all">
                                <div x-text="`${selectedBlock}${floor}0${room}`"></div>
                                <div class="text-xs mt-1 opacity-80" x-text="getRoomAvailability(`${selectedBlock}${floor}0${room}`) ? 'Available' : 'Occupied'"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <template x-for="block in blocks" :key="block.letter">
                <div @click="showBlock(block.letter)" 
                     class="bg-white rounded-xl p-8 border-2 border-gray-200 cursor-pointer transition-all duration-300 hover:border-primary hover:-translate-y-1 hover:shadow-xl text-center group">
                    <div class="text-6xl font-bold text-primary mb-4 group-hover:scale-110 transition-transform duration-300" x-text="block.letter"></div>
                    <h3 class="text-xl font-semibold text-primary mb-3" x-text="`Block ${block.letter}`"></h3>
                    <p class="text-sm text-gray-600 mb-1" x-text="`Rooms: ${block.letter}101-${block.letter}304`"></p>
                    <p class="text-sm text-gray-600 mb-3">3 floors</p>
                    <span class="inline-block bg-blue-50 text-primary px-4 py-1 rounded-full text-xs font-medium" x-text="block.location"></span>
                </div>
            </template>
        </div>
    </div>

    <!-- Added room schedule modal -->
    <div x-show="showModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto"
             @click.stop>
            <div class="sticky top-0 bg-primary text-white px-6 py-4 flex justify-between items-center rounded-t-2xl">
                <h3 class="text-2xl font-bold" x-text="`Room ${selectedRoom} - Weekly Schedule`"></h3>
                <button @click="showModal = false" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <!-- Day tabs -->
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    <template x-for="day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']" :key="day">
                        <button @click="selectedDay = day"
                                :class="selectedDay === day ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-all"
                                x-text="day">
                        </button>
                    </template>
                </div>

                <!-- Time slots for selected day -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <template x-for="slot in timeSlots" :key="slot">
                        <div :class="getRoomScheduleStatus(selectedRoom, selectedDay, slot) ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'"
                             class="border-2 rounded-lg p-4 text-center">
                            <div class="font-bold text-lg" x-text="slot"></div>
                            <div class="text-sm mt-1" x-text="getRoomScheduleStatus(selectedRoom, selectedDay, slot) ? '‚úì Available' : '‚úó Occupied'"></div>
                        </div>
                    </template>
                </div>

                <!-- No schedule message -->
                <div x-show="!hasScheduleForDay(selectedRoom, selectedDay)" 
                     class="text-center py-12 text-gray-500">
                    <p class="text-lg">No schedule set for this day</p>
                    <p class="text-sm mt-2">Room is available by default</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function roomFinder() {
            return {
                currentTime: '',
                selectedBlock: null,
                loading: false,
                error: null,
                rooms: [],
                schedules: [],
                blocks: [
                    { letter: 'D', location: 'East Campus' },
                    { letter: 'E', location: 'East Campus' },
                    { letter: 'F', location: 'Central Campus' },
                    { letter: 'G', location: 'Central Campus' },
                    { letter: 'H', location: 'West Campus' },
                    { letter: 'I', location: 'West Campus' }
                ],
                showModal: false,
                selectedRoom: null,
                selectedDay: 'Monday',
                timeSlots: [
                    '8:30-9:20', '9:30-10:20', '10:30-11:20', '11:30-12:20',
                    '12:30-13:20', '13:30-14:20', '14:30-15:20', '15:30-16:20', '16:30-17:20'
                ],
                async init() {
                    const role = localStorage.getItem('role');
                    const user = localStorage.getItem('user');
                    if (!role || !user) {
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                    
                    await this.loadRoomsAndSchedules();
                },
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                },
                async loadRoomsAndSchedules() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const { data: rooms, error: roomsError } = await getAllRooms();
                        if (roomsError) throw roomsError;
                        this.rooms = rooms || [];
                        
                        const { data: schedules, error: schedulesError } = await getRoomSchedules();
                        if (schedulesError) throw schedulesError;
                        this.schedules = schedules || [];
                    } catch (err) {
                        console.error('Error loading room data:', err);
                        this.error = 'Failed to load room schedules. Please try again later.';
                    } finally {
                        this.loading = false;
                    }
                },
                showBlock(letter) {
                    this.selectedBlock = letter;
                    setTimeout(() => {
                        document.querySelector('[x-show="selectedBlock && !loading"]')?.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest' 
                        });
                    }, 100);
                },
                getRoomAvailability(roomNumber) {
                    const room = this.rooms.find(r => `${r.block}${r.room_number}` === roomNumber);
                    if (!room) return false;
                    
                    const now = new Date();
                    const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    
                    // Find current time slot
                    const roomSchedules = this.schedules.filter(s => s.room_id === room.id && s.day_of_week === dayOfWeek);
                    
                    for (const schedule of roomSchedules) {
                        const [startTime] = schedule.time_slot.split('-');
                        const [startHour, startMinute] = startTime.split(':').map(Number);
                        
                        if (currentHour === startHour && Math.abs(currentMinute - startMinute) < 50) {
                            return schedule.is_available;
                        }
                    }
                    
                    return true; // Default to available if no matching slot
                },
                showRoomDetails(roomNumber) {
                    this.selectedRoom = roomNumber;
                    this.selectedDay = 'Monday';
                    this.showModal = true;
                },
                getRoomScheduleStatus(roomNumber, dayOfWeek, timeSlot) {
                    const room = this.rooms.find(r => `${r.block}${r.room_number}` === roomNumber);
                    if (!room) return true; // Default to available
                    
                    const schedule = this.schedules.find(s => 
                        s.room_id === room.id && 
                        s.day_of_week === dayOfWeek && 
                        s.time_slot === timeSlot
                    );
                    
                    return schedule ? schedule.is_available : true; // Default to available
                },
                hasScheduleForDay(roomNumber, dayOfWeek) {
                    const room = this.rooms.find(r => `${r.block}${r.room_number}` === roomNumber);
                    if (!room) return false;
                    
                    return this.schedules.some(s => 
                        s.room_id === room.id && 
                        s.day_of_week === dayOfWeek
                    );
                },
                getFloorName(floor) {
                    return floor === 1 ? '1st Floor' : floor === 2 ? '2nd Floor' : '3rd Floor';
                }
            }
        }

        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle-btn').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle-btn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        document.addEventListener('DOMContentLoaded', initTheme);
    </script>
</body>
</html>
